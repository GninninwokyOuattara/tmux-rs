# tmux-rs

An in-progress rust port of tmux. This project should be considered pre-alpha quality and may not necessarily be in a building state.

I don't think or want this project to displace tmux. I love using tmux.
Tmux will also continue development while I'm working on this port,
so the structure of the rust code must match that of the C project.
I tried out using [zellij](https://zellij.dev/) once and gave up when the compilation time was something like 40 minutes on my machine.
For me, this refactor is kinda like gardening (I don't garden, but if I did I'd imagine that's what it's like).
Every minute I spend on this is a minute I don't spend mindlessly playing some video game, so I take it as a net win.

I started this endeavour as a way of getting first hand experience with using C2Rust.
It's simultaneously a great and a terrible tool. I was amazed when I used it that it
was able to produce rust code which compiled to a binary which was effectively equivalent to the original C binary.
Unfortunately, the resulting rust code ... leaves a lot to be desired.
My initial approach was starting with the mess generated by C2Rust and slowly de-duplicating
the section generated from the headers and then manually re-writing file by file.

The problem with this approach is the C2Rust duplicates the definitions from C `.h` header files.
This means every ~200 line C file results in a >1000 line rust file.
Furthermore, the Rust code generated is unsafe (this is okay), and unreadable (unacceptable).
The generated code doesn't retain the original intent of the C code, though it may be equivalent.
Think using constants like `42` instead of `b'*'` when the original C code used `'*'`.
The code may be equivalent, but it renders the resulting Rust code useless without the original C source.
That's not the goal of a port. You want to be able to through away the original code after the port and not have lost any information.

Eventually, I got to a point where I had so much in progress code in a non-building state that I gave up
and had to rethink this approach to porting. I've since started over many times.
My current approach is creating many "micro-crates" each of which correspond to each `.c` translational unit.
For now, this approach requires some manual editing of generated Makefiles. This isn't ideal.
If my understanding of autotools was better, I'd try to seamlessly integrate the building of the rust
crates into the original project structure. For now I have a `build.sh` script in the root which
calls make and cargo.


# Progress

- [X] log
- [X] xmalloc
- [X] compat
- [X] cmd-kill-server
- [ ] window
  - [ ] TODO remove temporary `extern "C"` shim blocks
  - [ ] Fix errors
- [ ] tmux.h
  - [ ] many extra functions are not included
- [ ] alert.c
    - [ ] implement TODO's
- [ ] ...

# Notes

## Compat

tmux is a *bsd project.
I'm not sure which bsd exactly, but it's clear from reading the source code there's many libc functions
used which don't exist on linux, and are provided by bsd. The tmux project makes use of code in the compat
directory and autotools to shim these functions on OS's which they aren't provided. The first area to port
is this. Many linux distro's provide some of these functions already implemented through a library called
libbsd. I made a libbsd-sys library that provides auto-generated rust bindings to this C library. The surface
area of these functions is quite small and could easily be reimplemented later to remove this dependency.

## queue.h and tree.h

The tmux project makes extensive use of macros in the `compat/queue.h` and `compat/tree.h` headers which
implement an intrusive linked list and intrusive red black tree. For the most part, I've been able
to mirror the implementations at the source level using Rust generics. This is a key area to get right.
The auto-generated expanded C macros generated a mess from this code. This code needs to be hand crafted
properly to make use of rust generics which is abi compatible with the original C code. Maybe in the future
it would make sense to instead make use of a crate which provides the same functionality such as [intrusive_collections](https://docs.rs/intrusive-collections/latest/intrusive_collections/).


# References

- [tmux](https://github.com/tmux/tmux)
- [C2Rust](https://github.com/immunant/c2rust)
- [rust-bindgen](https://rust-lang.github.io/rust-bindgen/)
- [Compiling C to Safe Rust, Formalized](https://arxiv.org/abs/2412.15042)
- [Porting C to Rust for a Fast and Safe AV1 Media Decoder](https://www.memorysafety.org/blog/porting-c-to-rust-for-av1/)
- [Fish 4.0: The Fish Of Theseus](https://fishshell.com/blog/rustport/)
- [Immunant's C2Rust tmux](https://github.com/immunant/tmux-rs)
